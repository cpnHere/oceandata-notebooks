# install goofys for s3-mount
COPY --from=public.ecr.aws/smce/smce-images:smce-oss-earth-base-9f9fc2c3 /opt/goofys /opt/goofys

# install aws cli
USER root
RUN curl --no-progress-meter -o "awscliv2.zip" "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" && \
    unzip awscliv2.zip && \
    ./aws/install && \
    rm -rf awscliv2.zip aws
USER ${NB_USER}

# install OCSSW core files (i.e. without $OCSSWROOT/share or $OCSSWROOT/var)
ARG OCSSWTAG=V2024.6
ARG OCSSWROOT=/opt/ocssw
USER root
RUN /usr/bin/install -o ${NB_USER} -g ${NB_USER} -d ${OCSSWROOT}
USER ${NB_USER}
RUN curl --no-progress-meter -O https://oceandata.sci.gsfc.nasa.gov/manifest/install_ocssw && \
    curl --no-progress-meter -O https://oceandata.sci.gsfc.nasa.gov/manifest/manifest.py && \
    chmod +x install_ocssw && \
    ./install_ocssw --tag=${OCSSWTAG} --root --bin --opt && \
    ln -s /efs/ocssw/share ${OCSSWROOT} && \
    ln -s /efs/ocssw/var ${OCSSWROOT} && \
    rm install_ocssw manifest.py

# install (locked) dependencies for oceandata-notebooks[docker]
RUN pip install --no-cache-dir --no-deps \
      --no-binary h5py \
      --no-binary netcdf4 \
      -r requirements.txt

# environment variables
# FIXME: need PATH=${PATH}:/opt/goofys/bin ?
ENV EDITOR=nano OCSSWROOT=${OCSSWROOT}

CMD ["jupyter", "lab", "--no-browser", "--ip", "0.0.0.0"]

# TODO: set up gh-scoped-creds
# tell gh-scoped-creds which GitHub app to use for push access
# see https://github.com/jupyterhub/gh-scoped-creds#github-app-configuration
# ENV GH_SCOPED_CREDS_CLIENT_ID=
# ENV GH_SCOPED_CREDS_APP_URL=
